<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USN/WATCH</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body,#root{height:100%;margin:0;overflow:hidden}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const THREAT_RULES = [
      { id:"exe_create",  label:"EXE CREATED",    severity:"critical", match: r => r.reasons.includes("FILECREATE") && r.fileName?.endsWith(".exe") },
      { id:"dll_create",  label:"DLL CREATED",    severity:"critical", match: r => r.reasons.includes("FILECREATE") && r.fileName?.endsWith(".dll") },
      { id:"ps1_write",   label:"SCRIPT WRITTEN", severity:"high",     match: r => r.reasons.includes("CLOSE") && (r.fileName?.endsWith(".ps1") || r.fileName?.endsWith(".bat") || r.fileName?.endsWith(".cmd")) },
      { id:"sys_delete",  label:"SYSTEM DEL",     severity:"high",     match: r => r.reasons.includes("FILEDELETE") && r.fullPath?.includes("\\Windows\\") },
      { id:"startup_mod", label:"STARTUP MOD",    severity:"critical", match: r => r.fullPath?.toLowerCase().includes("startup") && r.reasons.includes("CLOSE") },
      { id:"hosts_mod",   label:"HOSTS MODIFIED", severity:"critical", match: r => r.fileName?.toLowerCase() === "hosts" && r.reasons.includes("CLOSE") },
      { id:"evtx_write",  label:"LOG TAMPER",     severity:"high",     match: r => r.fileName?.endsWith(".evtx") && r.reasons.includes("CLOSE") },
      { id:"bulk_delete", label:"BULK DELETE",    severity:"medium",   match: r => r.reasons.includes("FILEDELETE") && !r.fullPath?.includes("Temp") },
      { id:"shadow_mod",  label:"SHADOW COPY",    severity:"critical", match: r => r.fullPath?.includes("ShadowCopy") || r.fileName?.includes("vss") },
      { id:"hive_write",  label:"HIVE WRITE",     severity:"high",     match: r => (r.fileName?.endsWith(".hiv") || r.fileName?.endsWith(".dat")) && r.fullPath?.includes("\\registry\\") },
    ];

    const SEV = { critical:"#ff2d55", high:"#ff6b00", medium:"#ffd60a", low:"#30d158" };

    function classify(r) {
      for (const rule of THREAT_RULES) { try { if (rule.match(r)) return rule; } catch {} }
      return null;
    }

    const getDir = p  => { if (!p) return "unknown"; const a = p.split("\\"); return a.slice(0,-1).join("\\") || "\\"; };
    const getExt = f  => { if (!f) return ""; const i = f.lastIndexOf("."); return i >= 0 ? f.slice(i) : ""; };
    const trunc  = (s,n) => { if (!s) return ""; return s.length > n ? "…" + s.slice(-(n-1)) : s; };
    const fmtT   = ts => { try { return new Date(ts).toLocaleTimeString("en-US",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"}); } catch { return ""; } };
    const short  = r  => r.replace("FILECREATE","CREATE").replace("FILEDELETE","DELETE").replace("DATAOVERWRITE","OVERWRITE").replace("DATAEXTEND","EXTEND").replace("DATATRUNCATION","TRUNC").replace("BASICINFOCHANGE","ATTR").replace("RENAMEOLDNAME","REN-").replace("RENAMENEWNAME","REN+").replace("SECURITYCHANGE","SEC");

    function Sparkline({ data, color="#00ff88", height=32 }) {
      const max = Math.max(...data, 1), w=120, h=height;
      const pts = data.map((v,i) => `${(i/(data.length-1))*w},${h-(v/max)*h}`).join(" ");
      return <svg width={w} height={h} style={{display:"block"}}><polyline points={pts} fill="none" stroke={color} strokeWidth="1.5" strokeLinejoin="round"/></svg>;
    }

    const CSS = `
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@700;800&display=swap');
      *{box-sizing:border-box;margin:0;padding:0}
      :root{--bg:#080c10;--sf:#0d1117;--br:#1e2d3d;--green:#00ff88;--red:#ff2d55;--or:#ff6b00;--yl:#ffd60a;--bl:#0af0ff;--dim:#3d5166;--tx:#c9d1d9;--mono:'JetBrains Mono',monospace;--head:'Syne',sans-serif}
      body{background:var(--bg);color:var(--tx);font-family:var(--mono)}
      .dash{display:grid;grid-template-rows:48px 1fr;height:100vh;overflow:hidden}
      /* header */
      .hdr{display:flex;align-items:center;gap:24px;padding:0 20px;background:var(--sf);border-bottom:1px solid var(--br)}
      .logo{font-family:var(--head);font-size:13px;font-weight:800;letter-spacing:3px;color:var(--green);text-transform:uppercase}
      .logo span{color:var(--dim)}
      .status{display:flex;align-items:center;gap:6px;font-size:10px;letter-spacing:1px;color:var(--dim)}
      .dot{width:6px;height:6px;border-radius:50%;background:var(--dim)}
      .dot.live{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
      @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
      .hstats{display:flex;gap:20px;margin-left:auto}
      .hs{display:flex;flex-direction:column;align-items:flex-end}
      .hs-v{font-size:13px;font-weight:700;color:var(--green);line-height:1}
      .hs-v.warn{color:var(--red)}
      .hs-l{font-size:9px;letter-spacing:1px;color:var(--dim);text-transform:uppercase}
      /* layout */
      .body{display:grid;grid-template-columns:1fr 260px;overflow:hidden}
      .left{display:grid;grid-template-rows:auto 1fr;overflow:hidden;border-right:1px solid var(--br)}
      /* tabs */
      .tabs{display:flex;border-bottom:1px solid var(--br);background:var(--sf)}
      .tab{padding:10px 18px;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;color:var(--dim);border:none;border-bottom:2px solid transparent;background:none;font-family:var(--mono);transition:color .15s}
      .tab:hover{color:var(--tx)}
      .tab.on{color:var(--green);border-bottom-color:var(--green)}
      .badge{display:inline-block;margin-left:6px;padding:1px 5px;border-radius:3px;background:var(--red);color:#fff;font-size:9px}
      .fbar{padding:6px 12px;border-bottom:1px solid var(--br);background:var(--bg)}
      .finp{width:100%;background:none;border:none;outline:none;font-family:var(--mono);font-size:11px;color:var(--tx);caret-color:var(--green)}
      .finp::placeholder{color:var(--dim)}
      /* feed */
      .feed{overflow-y:auto;font-size:10.5px;line-height:1.4}
      .feed::-webkit-scrollbar{width:4px}
      .feed::-webkit-scrollbar-thumb{background:var(--br);border-radius:2px}
      .erow{display:grid;grid-template-columns:80px 1fr auto;gap:8px;padding:5px 12px;border-bottom:1px solid #0a0f14;align-items:center;transition:background .1s;border-left:2px solid transparent}
      .erow:hover{background:#0d1a26}
      .erow.critical{border-left-color:var(--red)}
      .erow.high{border-left-color:var(--or)}
      .erow.medium{border-left-color:var(--yl)}
      .etime{color:var(--dim);font-size:9.5px;white-space:nowrap}
      .eusn{font-size:8px;color:#2d4a5e;margin-top:1px}
      .efile{color:#e6edf3;font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
      .epath{color:var(--dim);font-size:9.5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
      .ereasons{display:flex;flex-wrap:wrap;gap:3px;justify-content:flex-end}
      .rtag{padding:1px 5px;border-radius:2px;font-size:8.5px;letter-spacing:.5px;background:#1e2d3d;color:var(--dim);white-space:nowrap}
      .rtag.CLOSE{color:var(--green);background:#001a0d}
      .rtag.FILECREATE{color:var(--bl);background:#001a2e}
      .rtag.FILEDELETE{color:var(--red);background:#1a0010}
      .rtag.RENAMENEWNAME{color:var(--yl);background:#1a1200}
      /* alerts */
      .arow{display:grid;grid-template-columns:auto 1fr;gap:10px;padding:8px 12px;border-bottom:1px solid var(--br);align-items:start}
      .asev{padding:2px 6px;font-size:8px;font-weight:700;letter-spacing:1px;border-radius:2px;white-space:nowrap;margin-top:2px}
      .alabel{font-size:10px;font-weight:700;color:#e6edf3}
      .afile{font-size:9.5px;color:var(--dim);margin-top:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
      /* stats */
      .spane{overflow-y:auto;padding:12px}
      .spane::-webkit-scrollbar{width:4px}
      .spane::-webkit-scrollbar-thumb{background:var(--br)}
      .sgroup{margin-bottom:20px}
      .sglabel{font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px}
      .srow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:6px}
      .sbw{height:3px;background:var(--br);border-radius:2px;margin-top:3px}
      .sb{height:3px;border-radius:2px;transition:width .5s}
      .sname{font-size:9.5px;color:var(--tx);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
      .scnt{font-size:10px;font-weight:700;white-space:nowrap}
      /* sidebar */
      .sidebar{display:flex;flex-direction:column;overflow:hidden;background:var(--sf)}
      .ssec{padding:12px;border-bottom:1px solid var(--br)}
      .slbl{font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:10px}
      .rbig{font-family:var(--head);font-size:36px;font-weight:800;color:var(--green);line-height:1}
      .runit{font-size:10px;color:var(--dim);margin-top:2px}
      .extg{display:flex;flex-wrap:wrap;gap:4px}
      .extc{padding:2px 7px;border-radius:3px;font-size:9px;background:#1e2d3d;color:var(--tx);display:flex;gap:5px;align-items:center}
      .extc span{color:var(--green);font-weight:700}
      .sscroll{overflow-y:auto;flex:1}
      .sscroll::-webkit-scrollbar{width:3px}
      .sscroll::-webkit-scrollbar-thumb{background:var(--br)}
      .tmini{padding:8px 12px;border-bottom:1px solid var(--br);display:flex;gap:8px;align-items:flex-start}
      .tdot{width:7px;height:7px;border-radius:50%;margin-top:4px;flex-shrink:0}
      .tlbl{font-size:9.5px;font-weight:700;color:#e6edf3}
      .tfile{font-size:8.5px;color:var(--dim);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;margin-top:1px}
      .empty{padding:24px;color:var(--dim);font-size:11px;text-align:center}
      .noconn{padding:5px 12px;font-size:9px;color:var(--or);background:#120800;border-bottom:1px solid var(--br);letter-spacing:1px}
      .dim{color:var(--dim);font-size:10px}
    `;

    function Dashboard() {
      const [events,      setEvents]      = useState([]);
      const [alerts,      setAlerts]      = useState([]);
      const [topFiles,    setTopFiles]    = useState([]);
      const [topDirs,     setTopDirs]     = useState([]);
      const [topExts,     setTopExts]     = useState([]);
      const [rateHistory, setRateHistory] = useState(Array(30).fill(0));
      const [totalEvents, setTotalEvents] = useState(0);
      const [connected,   setConnected]   = useState(false);
      const [filterText,  setFilterText]  = useState("");
      const [tab,         setTab]         = useState("feed");

      const eventBuf    = useRef([]);
      const fileCounts  = useRef({});
      const dirCounts   = useRef({});
      const extCounts   = useRef({});
      const secondCount = useRef(0);
      const wsRef       = useRef(null);
      const retryRef    = useRef(null);

      function connect() {
        try {
          const ws = new WebSocket("ws://localhost:9876");
          wsRef.current = ws;
          ws.onopen  = () => setConnected(true);
          ws.onclose = () => { setConnected(false); retryRef.current = setTimeout(connect, 3000); };
          ws.onerror = () => { setConnected(false); ws.close(); };
          ws.onmessage = e => {
            let ev; try { ev = JSON.parse(e.data); } catch { return; }
            // normalise: daemon emits `reason` array, dashboard expects `reasons`
            if (!ev.reasons) ev.reasons = ev.reason ?? [];
            if (!Array.isArray(ev.reasons)) ev.reasons = [ev.reasons];

            const threat = classify(ev);
            if (threat) setAlerts(p => [{ ...threat, event:ev, uid:(ev.usn??Date.now())+Math.random() }, ...p].slice(0,100));

            if (ev.fullPath) {
              fileCounts.current[ev.fullPath] = (fileCounts.current[ev.fullPath]||0)+1;
              const d = getDir(ev.fullPath);
              dirCounts.current[d] = (dirCounts.current[d]||0)+1;
            }
            const ext = getExt(ev.fileName);
            if (ext) extCounts.current[ext] = (extCounts.current[ext]||0)+1;
            secondCount.current++;
            eventBuf.current = [ev, ...eventBuf.current].slice(0,500);
            setEvents([...eventBuf.current]);
            setTotalEvents(t => t+1);
          };
        } catch { retryRef.current = setTimeout(connect, 3000); }
      }

      useEffect(() => {
        connect();
        const stats = setInterval(() => {
          setTopFiles(Object.entries(fileCounts.current).sort((a,b)=>b[1]-a[1]).slice(0,8));
          setTopDirs( Object.entries(dirCounts.current ).sort((a,b)=>b[1]-a[1]).slice(0,8));
          setTopExts( Object.entries(extCounts.current ).sort((a,b)=>b[1]-a[1]).slice(0,12));
          setRateHistory(p => [...p.slice(1), secondCount.current]);
          secondCount.current = 0;
        }, 1000);
        return () => { clearTimeout(retryRef.current); try{wsRef.current?.close();}catch{} clearInterval(stats); };
      }, []);

      const filtered = filterText
        ? events.filter(e => (e.fullPath||e.fileName||"").toLowerCase().includes(filterText.toLowerCase()) || e.reasons.join(" ").toLowerCase().includes(filterText.toLowerCase()))
        : events;

      const evRate  = rateHistory[rateHistory.length-1];
      const aCnt    = alerts.length;
      const maxFile = topFiles[0]?.[1]||1;
      const maxDir  = topDirs[0]?.[1]||1;

      return (
        <>
          <style>{CSS}</style>
          <div className="dash">

            <header className="hdr">
              <div className="logo">USN<span>/</span>WATCH</div>
              <div className="status">
                <div className={`dot ${connected?"live":""}`}/>
                {connected ? "LIVE · C:\\" : "WAITING FOR BRIDGE"}
              </div>
              <div className="hstats">
                <div className="hs"><div className="hs-v">{totalEvents.toLocaleString()}</div><div className="hs-l">Total Events</div></div>
                <div className="hs"><div className="hs-v">{evRate}/s</div><div className="hs-l">Event Rate</div></div>
                <div className="hs"><div className={`hs-v ${aCnt>0?"warn":""}`}>{aCnt}</div><div className="hs-l">Alerts</div></div>
              </div>
            </header>

            <div className="body">
              <div className="left">
                <div>
                  {!connected && <div className="noconn">⚠ NOT CONNECTED — run ws-bridge.exe · retrying every 3s</div>}
                  <div className="tabs">
                    <button className={`tab ${tab==="feed"?"on":""}`}   onClick={()=>setTab("feed")}>Event Feed</button>
                    <button className={`tab ${tab==="alerts"?"on":""}`} onClick={()=>setTab("alerts")}>Alerts{aCnt>0&&<span className="badge">{aCnt}</span>}</button>
                    <button className={`tab ${tab==="stats"?"on":""}`}  onClick={()=>setTab("stats")}>Top Activity</button>
                  </div>
                  {tab==="feed" && <div className="fbar"><input className="finp" placeholder="filter by path, filename, reason…" value={filterText} onChange={e=>setFilterText(e.target.value)}/></div>}
                </div>

                {tab==="feed" && (
                  <div className="feed">
                    {filtered.length===0 && <div className="empty">{connected?"Waiting for events…":"Open dashboard.html and run ws-bridge.exe"}</div>}
                    {filtered.map((ev,i) => {
                      const t = classify(ev);
                      return (
                        <div key={ev.usn??i} className={`erow ${t?.severity||""}`}>
                          <div className="etime">{fmtT(ev.timestamp)}<div className="eusn">{String(ev.usn||"").slice(-6)}</div></div>
                          <div style={{overflow:"hidden"}}>
                            <div className="efile">{ev.fileName}</div>
                            <div className="epath">{trunc(ev.fullPath||"",60)}</div>
                          </div>
                          <div className="ereasons">
                            {ev.reasons.slice(0,3).map(r=><span key={r} className={`rtag ${r}`}>{short(r)}</span>)}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {tab==="alerts" && (
                  <div className="feed">
                    {alerts.length===0 && <div className="empty">No threats detected</div>}
                    {alerts.map(a=>(
                      <div key={a.uid} className="arow">
                        <div className="asev" style={{background:SEV[a.severity]+"22",color:SEV[a.severity]}}>{a.severity.toUpperCase()}</div>
                        <div style={{overflow:"hidden"}}>
                          <div className="alabel">{a.label}</div>
                          <div className="afile">{a.event.fullPath||a.event.fileName}</div>
                          <div style={{fontSize:"8.5px",color:"var(--dim)",marginTop:"2px"}}>{a.event.reasons.join(" · ")}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {tab==="stats" && (
                  <div className="spane">
                    <div className="sgroup">
                      <div className="sglabel">Top Files by Event Count</div>
                      {topFiles.length===0 && <div className="dim">No data yet</div>}
                      {topFiles.map(([p,c])=>(
                        <div key={p} className="srow">
                          <div style={{overflow:"hidden"}}>
                            <div className="sname">{p.split("\\").pop()}</div>
                            <div className="sbw"><div className="sb" style={{width:(c/maxFile*100)+"%",background:"var(--green)"}}/></div>
                            <div style={{fontSize:"8.5px",color:"var(--dim)",marginTop:"2px"}}>{trunc(p,55)}</div>
                          </div>
                          <div className="scnt" style={{color:"var(--green)"}}>{c}</div>
                        </div>
                      ))}
                    </div>
                    <div className="sgroup">
                      <div className="sglabel">Top Directories</div>
                      {topDirs.length===0 && <div className="dim">No data yet</div>}
                      {topDirs.map(([d,c])=>(
                        <div key={d} className="srow">
                          <div style={{overflow:"hidden"}}>
                            <div className="sname">{trunc(d,48)}</div>
                            <div className="sbw"><div className="sb" style={{width:(c/maxDir*100)+"%",background:"var(--bl))"}}/></div>
                          </div>
                          <div className="scnt" style={{color:"var(--bl)"}}>{c}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="sidebar">
                <div className="ssec">
                  <div className="slbl">Event Rate</div>
                  <div className="rbig">{evRate}</div>
                  <div className="runit">events / sec</div>
                  <div style={{marginTop:"8px"}}><Sparkline data={rateHistory} color="#00ff88"/></div>
                </div>
                <div className="ssec">
                  <div className="slbl">File Types</div>
                  <div className="extg">
                    {topExts.length===0 && <div className="dim">No data yet</div>}
                    {topExts.slice(0,12).map(([e,c])=><div key={e} className="extc">{e}<span>{c}</span></div>)}
                  </div>
                </div>
                <div className="ssec" style={{paddingBottom:"8px"}}><div className="slbl">Recent Alerts</div></div>
                <div className="sscroll">
                  {alerts.length===0 && <div style={{padding:"12px",color:"var(--dim)",fontSize:"9.5px"}}>No alerts</div>}
                  {alerts.slice(0,20).map(a=>(
                    <div key={a.uid} className="tmini">
                      <div className="tdot" style={{background:SEV[a.severity],boxShadow:`0 0 6px ${SEV[a.severity]}`}}/>
                      <div style={{overflow:"hidden"}}>
                        <div className="tlbl">{a.label}</div>
                        <div className="tfile">{a.event.fileName}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);
  </script>
</body>
</html>
